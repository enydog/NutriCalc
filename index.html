<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Interactive Simulator (Nutrition Planning) — CP · kJ/kg · CHO</title>
  <style>
    :root{
      --bg1:#0b1220; --bg2:#0f172a; --bg3:#1e293b;
      --card:#0f172a; --ink:#e5e7eb; --muted:#94a3b8;
      --border:#22314b; --accent:#22d3ee; --accent2:#a78bfa;
      --logo-url: url('logo.png');
    }
    *{box-sizing:border-box}
    body{margin:0;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(34,211,238,.18), transparent 60%),
                  radial-gradient(1200px 700px at 100% 0%, rgba(167,139,250,.18), transparent 60%),
                  linear-gradient(135deg,var(--bg1),var(--bg2) 55%,var(--bg3));}
    .wrap{max-width:1180px;margin:0 auto;padding:18px}
    h1{font-weight:800;letter-spacing:-.01em;margin:0 0 4px;font-size:24px}
    .muted{color:var(--muted);font-size:12px;margin:0}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:1024px){.grid{grid-template-columns:2fr 3fr}}
    .card{background:linear-gradient(180deg,rgba(17,24,39,.9),rgba(17,24,39,.85));border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .row-tight{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    .label{font-size:11px;color:#a3b2c7;margin-bottom:2px}
    .ibox{display:flex;align-items:center;gap:8px;border:1px solid var(--border);padding:6px 8px;border-radius:10px;background:rgba(2,6,23,.6)}
    input[type=number]{width:100%;border:0;outline:0;font-size:13px;color:var(--ink);background:transparent}
    input[type=range]{width:100%;height:20px}
    select{width:100%;border:1px solid var(--border);background:rgba(2,6,23,.6);color:var(--ink);border-radius:10px;padding:6px 8px;font-size:12px}
    .pill{background:rgba(2,6,23,.6);border:1px solid var(--border);border-radius:12px;padding:6px 10px}
    .pill .t{font-size:10px;color:#9aa6b2}
    .pill .v{font-weight:700}
    .btn{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#0b1220;border:0;border-radius:10px;padding:6px 10px;font-size:12px;cursor:pointer}
    .chart-wrap{width:100%;height:320px;position:relative}
    .overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#cbd5e1;border:1px dashed rgba(255,255,255,.08);border-radius:10px;background:linear-gradient(180deg, rgba(2,6,23,.55), rgba(2,6,23,.30));padding:8px}
    svg{width:100%;height:100%}
    .chart-wrap{position:relative}
    .chart-wrap::before{content:"";position:absolute;inset:0;background-repeat:no-repeat;background-position:calc(100% - 12px) 12px;background-size:120px auto;opacity:.12;filter:saturate(1.05);pointer-events:none;z-index:0;background-image:var(--logo-url)}
    .chart-wrap svg{position:relative;z-index:1}
    .overlay{z-index:2}
    .overlay .ovl{max-width:560px;text-align:center;line-height:1.25;text-shadow:0 1px 2px rgba(0,0,0,.45)}
    .overlay .ovl-strong{font-size:20px;font-weight:800;letter-spacing:.2px;color:#e5e7eb;margin:2px 0 4px}
    .overlay .ovl-line{font-size:13px;color:#cbd5e1}
    .overlay .ovl-sub{font-size:12px;color:#9fb2c7}
    .toolbar{display:flex;gap:8px;align-items:center}
    .brand{display:flex;align-items:center;gap:10px;margin-bottom:6px}
    .brand img.logo{height:40px;width:auto;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.35)}
    @media (max-width:480px){.brand img.logo{height:32px}}
  </style>
  <link rel="icon" type="image/png" href="logo.png"/>
</head>
<body>
<div class="wrap">
  <div class="brand"><img class="logo" src="logo.png" alt="Logo" onerror="this.style.display='none'"/><div><h1>Interactive Simulator (Nutrition Planning)</h1><p class="muted">Author: <b>Gabriel Della Mattia</b> · Produced for <b>AGMT2.TEAM</b></p></div></div>

  <div class="grid" style="margin-top:8px">
    <!-- Left column -->
    <div>
      <div class="card">
        <div class="row-tight">
          <label>
            <div class="label">Weight</div>
            <div class="ibox">
              <input id="inp-weight" type="number" min="30" max="120" step="0.1" value="68"/>
              <span class="hint">kg</span>
            </div>
          </label>
          <label>
            <div class="label">CP (W) <span class="muted">(auto from MMP)</span></div>
            <div class="ibox">
              <input id="inp-cp" type="number" min="120" max="500" step="1" value="274"/>
              <span class="muted">W</span>
            </div>
          </label>
          <div class="pill" style="display:flex;flex-direction:column;justify-content:center">
            <div class="t">Estimation</div><div class="v" id="pill-cp">CP 250 · W′ ?</div>
          </div>
        </div>

        <!-- Athlete + mix display -->
        <div class="row-tight" style="margin-top:6px">
          <label>
            <div class="label">Athlete type</div>
            <select id="sel-athlete">
              <option value="trained">Well-trained</option>
              <option value="moderate" selected>Moderately trained</option>
              <option value="untrained">Low trained</option>
            </select>
          </label>
          <div class="pill"><div class="t">Fuel mix</div><div class="v" id="pill-mix">-</div></div>
          <div class="pill"><div class="t">Peak fat</div><div class="v" id="pill-fatpeak">-</div></div>
        </div>

        <!-- Manual mix HERE (what-if) -->
        <div class="row-tight" style="margin-top:6px;align-items:center">
          <label style="display:flex;align-items:center;gap:6px">
            <input type="checkbox" id="chk-manualmix">
            <span class="label" style="margin:0">Manual fuel mix (what-if)</span>
          </label>
          <label style="flex:1">
            <div class="label">% Fat (what-if)</div>
            <input type="range" id="rng-fat" min="0" max="95" step="1" value="60" disabled>
          </label>
          <div class="pill" style="min-width:110px">
            <div class="t">Manual</div><div class="v" id="pill-manualmix">off</div>
          </div>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
          <div>
            <div style="font-size:13px;font-weight:600">Power Curves (CSV)</div>
            <div class="muted">Wide m1..m18000 or long (Date, Duration, Power). &lt;60 s filtered.</div>
          </div>
          <div class="toolbar">
            <button id="btn-upload" class="btn">Upload CSV</button>
            <input id="file" type="file" accept=".csv,text/csv" hidden/>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:8px">
        <div style="font-size:13px;font-weight:600;margin-bottom:4px">Effort projection (compact)</div>
        <div class="row-tight">
          <label>
            <div class="label">Duration <b id="lbl-dur">60:00</b></div>
            <input id="rng-dur" type="range" min="3600" max="43200" step="60" value="3600"/>
          </label>
          <label>
            <div class="label">Power <b id="lbl-w">194 W</b></div>
            <input id="rng-w" type="range" min="50" max="800" step="5" value="194"/>
          </label>
          <label>
            <div class="label">Gross eff. <b id="lbl-eff">24%</b></div>
            <input id="rng-eff" type="range" min="0.18" max="0.25" step="0.01" value="0.24"/>
          </label>
        </div>

        <div class="row-tight" style="margin-top:6px">
          <div class="pill"><div class="t">Domain</div><div class="v" id="pill-domain">-</div></div>
          <div class="pill"><div class="t">Intensity</div><div class="v" id="pill-int">-</div></div>
          <div class="pill"><div class="t">kJ/kg</div><div class="v" id="pill-kjkg">-</div></div>
        </div>

        <div class="row-tight" style="margin-top:6px">
          <div class="pill"><div class="t">Mechanical kJ</div><div class="v" id="pill-kj">-</div></div>
          <div class="pill"><div class="t">Metabolic kcal</div><div class="v" id="pill-kcal">-</div></div>
          <div class="pill"><div class="t">kcal/kg</div><div class="v" id="pill-kcalkg">-</div></div>
        </div>
      </div>

      <div class="card" style="margin-top:8px">
        <div style="font-size:13px;font-weight:600;margin-bottom:4px">Didactic text</div>
        <div id="txt-session" style="color:#e5e7eb"></div>
        <div class="muted" style="margin-top:6px">kJ/kg = (W·s)/1000/kg. Fuel mix shifts with intensity and training; trained athletes oxidize more fat at a given %CP.</div>
      </div>
    </div>

    <!-- Right column -->
    <div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <div style="font-size:13px;font-weight:600">Ingestion timeline & muscle glycogen</div>
          <div class="toolbar">
            <button id="btn-copy" class="btn" title="Copy handlebar guide">Copy guide</button>
            <button id="btn-export" class="btn" title="Download TXT">Export TXT</button>
          </div>
        </div>
        <div class="muted" id="lbl-coverage" style="margin-bottom:6px">Load your CSV to estimate CP</div>
        <div class="chart-wrap">
          <div class="overlay" id="overlay"><div class="ovl"><div class="ovl-line">Fueling is generally</div><div class="ovl-strong">NOT REQUIRED &lt; 2 h</div><div class="ovl-sub">unless high intensity or low glycogen</div><div class="ovl-sub">Increase duration to see the schedule</div></div></div>
          <svg id="chart" viewBox="0 0 900 320" preserveAspectRatio="none"></svg>
        </div>
        <div class="row-tight" style="margin-top:8px">
          <div class="pill"><div class="t">Dose size</div><div class="v" id="pill-dose">-</div></div>
          <div class="pill"><div class="t"># doses</div><div class="v" id="pill-dose-n">-</div></div>
          <div class="pill"><div class="t">Last dose</div><div class="v" id="pill-dose-last">-</div></div>
        </div>
      </div>

      <div class="card" style="margin-top:8px">
        <div style="font-size:13px;font-weight:600;margin-bottom:6px">Carbohydrate strategy (stores + intake)</div>
        <div class="row">
          <label>
            <div class="label">Initial glycogen</div>
            <div class="ibox"><input id="inp-glyinit" type="number" min="100" max="800" step="10" value="400"/><span class="muted">g</span></div>
          </label>
          <label>
            <div class="label">Reserve to keep</div>
            <div class="ibox"><input id="inp-glyres" type="number" min="0" max="800" step="10" value="100"/><span class="muted">g</span></div>
          </label>
        </div>
        <div class="row" style="margin-top:6px">
          <label>
            <div class="label">Intestinal transport</div>
            <select id="sel-mode">
              <option value="G60">Glucose (SGLT1) · ≤60 g/h</option>
              <option value="GF90" selected>Glucose+Fructose (2:1) · ≤90 g/h</option>
              <option value="GF120">High (1:1, gut-trained) · ≤120 g/h</option>
            </select>
          </label>
          <label>
            <div class="label">Planned intake: <b id="lbl-intake">60 g/h</b> (cap <span id="lbl-intakecap">90</span>)</div>
            <input id="rng-intake" type="range" min="0" max="90" step="5" value="60"/>
          </label>
        </div>
        <div class="row" style="margin-top:6px">
          <label>
            <div class="label">Dose cadence</div>
            <select id="sel-cad">
              <option value="10">every 10 min</option>
              <option value="12">every 12 min</option>
              <option value="15" selected>every 15 min</option>
              <option value="20">every 20 min</option>
            </select>
          </label>
          <label>
            <div class="label">Start at</div>
            <select id="sel-start">
              <option value="0">0 min</option>
              <option value="10">10 min</option>
              <option value="15">15 min</option>
              <option value="20">20 min</option>
              <option value="120" selected>120 min (default for &lt;2h rule)</option>
            </select>
          </label>
        </div>
        <div class="row-3" style="margin-top:6px">
          <div class="pill"><div class="t">CHO required</div><div class="v" id="pill-cho-req">-</div></div>
          <div class="pill"><div class="t">Planned exogenous</div><div class="v" id="pill-cho-exo">-</div></div>
          <div class="pill"><div class="t">Final glycogen</div><div class="v" id="pill-gly-end">-</div></div>
        </div>
        <div class="row" style="margin-top:6px">
          <div class="pill" style="grid-column:1 / -1"><div class="t">Recommendation</div><div class="v" id="pill-cho-rec">-</div></div>
        </div>
        <div class="row" style="margin-top:6px">
          <div class="pill" style="grid-column:1 / -1"><div class="t">Split</div><div class="v" id="pill-split">-</div></div>
        </div>
        <div class="muted" style="margin-top:6px">Frequent small boluses (10–15′) aid tolerance & oxidation. 2:1 for ~90 g/h; 1:1 with gut training for ~120 g/h.</div>
      </div>
    </div>
  </div>

  <p class="muted" style="margin-top:8px">Title: <b>Simulador Interactivo (Planificacion Nutricion)</b> · Author: <b>Gabriel Della Mattia</b> · Produced for <b>AGMT2.TEAM</b></p>
</div>

<script>
/* ---------- helpers + state ---------- */
const $ = s => document.querySelector(s);
const fmt2 = n => n.toString().padStart(2,'0');
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
const fmtDur = s => {
  const h = Math.floor(s / 3600);
  const m = Math.floor((s % 3600) / 60);
  const sec = Math.floor(s % 60);
  // Si es <1h muestra m:ss, si no h:mm:ss
  return h ? `${h}:${fmt2(m)}:${fmt2(sec)}` : `${m}:${fmt2(sec)}`;
};

const state = { weight:68, cp:274, power:194, eff:0.24, athlete:'moderate',
  glyInit:400, glyReserve:100, intakeMode:'GF90', intake:60, cadence:15, startMin:120, dur:3600 };

/* ---------- UI wiring ---------- */
function wireInputs(){
  $('#rng-w').addEventListener('input', e=>{ state.power=+e.target.value; $('#lbl-w').textContent=`${state.power} W`; recompute(); });
  $('#rng-eff').addEventListener('input', e=>{ state.eff=+e.target.value; $('#lbl-eff').textContent=`${Math.round(state.eff*100)}%`; recompute(); });
  $('#rng-dur').addEventListener('input', e=>{ state.dur=+e.target.value; $('#lbl-dur').textContent=fmtDur(state.dur); recompute(); });
  $('#inp-weight').addEventListener('input', e=>{ state.weight=+e.target.value||72; recompute(); });
  $('#inp-cp').addEventListener('input', e=>{ state.cp=+e.target.value||250; $('#pill-cp').textContent=`CP ${state.cp} · W′ ?`; recompute(); });

  // Manual mix HERE
  const chk=$('#chk-manualmix'), rng=$('#rng-fat'), tag=$('#pill-manualmix');
  chk.addEventListener('change', ()=>{ rng.disabled=!chk.checked; tag.textContent=chk.checked?`${rng.value}% fat`:'off'; recompute(); });
  rng.addEventListener('input', ()=>{ tag.textContent=`${rng.value}% fat`; recompute(); });

  // Glycogen controls
  $('#inp-glyinit').addEventListener('input', e=>{ state.glyInit=clamp(+e.target.value||400,100,800); if(state.glyReserve>state.glyInit) state.glyReserve=state.glyInit; recompute(); });
  $('#inp-glyres').addEventListener('input', e=>{ state.glyReserve=clamp(+e.target.value||100,0,200); if(state.glyReserve>state.glyInit) state.glyReserve=state.glyInit; recompute(); });

  $('#sel-mode').addEventListener('change', e=>{
    state.intakeMode=e.target.value;
    const cap=state.intakeMode==='G60'?60:(state.intakeMode==='GF120'?120:90);
    $('#lbl-intakecap').textContent=cap; $('#rng-intake').max=cap;
    state.intake=Math.min(state.intake,cap); $('#rng-intake').value=state.intake; $('#lbl-intake').textContent=`${state.intake} g/h`; recompute();
  });
  $('#rng-intake').addEventListener('input', e=>{ state.intake=+e.target.value; $('#lbl-intake').textContent=`${state.intake} g/h`; recompute(); });
  $('#sel-cad').addEventListener('change', e=>{ state.cadence=+e.target.value; recompute(); });
  $('#sel-start').addEventListener('change', e=>{ state.startMin=+e.target.value; recompute(); });
  $('#sel-athlete').addEventListener('change', e=>{ state.athlete=e.target.value; recompute(); });

  window.addEventListener('resize', recompute);
}

/* ---------- fuel mix ---------- */
function fuelMix(power, cp, athlete){
  // manual what-if
  if ($('#chk-manualmix').checked){
    const fatFrac=clamp((+$('#rng-fat').value)/100,0,0.95);
    return {fatFrac, choFrac:1-fatFrac, peakFat:'manual'};
  }
  // model
  const r = clamp(power/Math.max(1,cp), 0, 1.3);
  const base=(athlete==='trained')?0.75:(athlete==='moderate')?0.62:0.52;
  const slope=(athlete==='trained')?1.10:(athlete==='moderate')?1.05:1.00;
  const fatFrac = clamp( base / (1 + Math.exp(6*(r-0.75))) * slope , 0.05, 0.85 );
  return {fatFrac, choFrac:1-fatFrac, peakFat:`${Math.round(base*100)}%`};
}

/* ---------- dosing ---------- */
function dosePlan(dur_s, cadence_min, start_min, rate_gph){
  const dur_min=dur_s/60, doseSize=rate_gph*(cadence_min/60);
  const times=[]; for(let t=start_min; t<=dur_min+1e-6; t+=cadence_min) if(t>=0&&t<=dur_min) times.push(t);
  return {doseSize,times,n:times.length,last:times.length?`${Math.floor(times.at(-1))}′`:'-'};
}

/* ---------- recompute + draw ---------- */
const chart=document.getElementById('chart'), overlay=document.getElementById('overlay');

function recompute(){
  overlay.style.display=(state.dur<7200)?'':'none';

  const {fatFrac,choFrac,peakFat}=fuelMix(state.power,state.cp,state.athlete);
  $('#pill-mix').textContent=`${Math.round(fatFrac*100)}% fat / ${Math.round(choFrac*100)}% CHO`;
  $('#pill-fatpeak').textContent=peakFat;

  const r=state.power/Math.max(1,state.cp);
  $('#pill-domain').textContent=(r<0.6)?'Moderate':(r<1.0)?'Heavy':(r<1.2)?'Severe':'Extreme';
  $('#pill-int').textContent=`${Math.round(r*100)}% CP`;

  const mech_kJ=state.power*state.dur/1000, met_kJ=mech_kJ/Math.max(0.01,state.eff), met_kcal=met_kJ*0.239006;
  $('#pill-kj').textContent=`${Math.round(mech_kJ)}`;
  $('#pill-kcal').textContent=`${Math.round(met_kcal)}`;
  $('#pill-kjkg').textContent=(mech_kJ/state.weight).toFixed(1);
  $('#pill-kcalkg').textContent=(met_kcal/state.weight).toFixed(1);

  const {doseSize,times,n,last}=dosePlan(state.dur,state.cadence,state.startMin,state.intake);
  $('#pill-dose').textContent=`${Math.round(doseSize)} g every ${state.cadence}′`;
  $('#pill-dose-n').textContent=`${n}`;
  $('#pill-dose-last').textContent=last;

  // simulación simple (g/min)
  const mins=Math.ceil(state.dur/60);
  let gly=state.glyInit;
  const series=[], cho_rate_gpm=state.intake/60;
  for(let m=0;m<=mins;m++){
    const kcal_min=(state.power/Math.max(0.01,state.eff))*60/4184;
    const cho_need_gpm=(kcal_min*(1-fuelMix(state.power,state.cp,state.athlete).fatFrac))/4.0;
    const exo=cho_rate_gpm; // bolus solo visual
    gly=Math.max(0, gly - Math.max(0,cho_need_gpm - exo));
    series.push({t:m,g:gly});
  }

  const cho_required=series.reduce((a,_,i)=>i?a+Math.max(0,series[i-1].g - series[i].g):0,0);
  const exogenous_total=(state.intake/60)*mins;
  $('#pill-cho-req').textContent=`${Math.round(cho_required)} g`;
  $('#pill-cho-exo').textContent=`${Math.round(exogenous_total)} g`;
  $('#pill-gly-end').textContent=`${Math.round(series.at(-1).g)} g`;
  $('#pill-cho-rec').textContent=(series.at(-1).g<state.glyReserve)?'Increase intake or reduce intensity':'OK';
  $('#pill-split').textContent=n?`${Math.round(doseSize)} g × ${n} doses (${state.cadence}′)`:'—';

  drawTimeline(series,times,doseSize);
}

/* ---------- svg utils ---------- */
function svgEl(tag,attrs={}){const el=document.createElementNS('http://www.w3.org/2000/svg',tag);for(const k in attrs)el.setAttribute(k,attrs[k]);return el;}
const svgLine=(x1,y1,x2,y2,a)=>svgEl('line',Object.assign({x1,y1,x2,y2},a));
const svgRect=(x,y,w,h,a)=>svgEl('rect',Object.assign({x,y,width:w,height:h,rx:0,ry:0},a));
const svgPath=(d,a)=>svgEl('path',Object.assign({d},a));
const svgText=(x,y,txt,a)=>{const t=svgEl('text',Object.assign({x,y},a));t.textContent=txt;return t;};

/* ---------- drawing ---------- */
function drawTimeline(series, doseTimes, doseSize){
  const W = chart.viewBox.baseVal.width  || 900;
  const H = chart.viewBox.baseVal.height || 320;
  const pad = { l:48, r:10, t:10, b:26 }, iw = W - pad.l - pad.r, ih = H - pad.t - pad.b;

  // Escalas
  const Gmax = Math.max(100, Math.max(state.glyInit, state.glyReserve) * 1.05);
  const yG = g => pad.t + ih - (g / Gmax) * ih;
  const xT = m => pad.l + (m / (state.dur / 60)) * iw; // m = minutos

  chart.innerHTML = '';

  // ---- Ejes
  const gAxis = svgEl('g', { stroke:'#2b3c57', 'stroke-width':'1' });

  // Y (g de glucógeno)
  for (let i = 0; i <= 5; i++){
    const gy = pad.t + ih * (i/5);
    const val = Math.round(Gmax * (1 - i/5));
    gAxis.appendChild(svgLine(pad.l, gy, W - pad.r, gy, { stroke:'#1a263c' }));
    const txt = svgText(8, gy + 4, `${val} g`, { fill:'#9fb2c7', 'font-size':'10px' });
    txt.setAttribute('x', 8);
    gAxis.appendChild(txt);
  }

  // X (min u horas)
  const durMin  = Math.round(state.dur / 60);
  const xTick   = durMin > 720 ? 120 : durMin > 360 ? 60 : 30; // 120' (2h), 60', 30'
  const useHours = durMin >= 180; // desde 3h mostramos "xh"

  for (let m = 0; m <= durMin + 0.001; m += xTick){
    const gx  = xT(m);
    const lbl = useHours ? `${Math.round(m/60)}h` : `${m}′`;
    gAxis.appendChild(svgLine(gx, pad.t, gx, pad.t + ih, { stroke:'#1a263c' }));
    gAxis.appendChild(svgText(gx, H - 6, lbl, { fill:'#9fb2c7', 'font-size':'10px', 'text-anchor':'middle' }));
  }
  chart.appendChild(gAxis);

  // ---- Zona de reserva (roja)
  const yReserve = yG(state.glyReserve);
  chart.appendChild(svgRect(pad.l, yReserve, iw, pad.t + ih - yReserve, { fill:'#ef4444', opacity:0.18 }));
  chart.appendChild(svgLine(pad.l, yReserve, pad.l + iw, yReserve, { stroke:'#ef4444', 'stroke-dasharray':'4 4', 'stroke-width':1.5 }));

  // ---- Barras de dosis (violeta), altura proporcional a gramos/dosis
  const barW = Math.max(6, iw / (durMin + 1) / 1);
  doseTimes.forEach(t => {
    const x = xT(t) - barW / 2;
    const y = yG(doseSize);
    const h = (pad.t + ih) - y;
    chart.appendChild(svgRect(x, y, barW, h, { fill:'#a78bfa', opacity:0.45, stroke:'#a78bfa', 'stroke-width':1 }));
  });

  // ---- Curva de glucógeno (celeste)
  const pathD = series.map((p,i) => `${i ? 'L':'M'} ${xT(p.t)} ${yG(p.g)}`).join(' ');
  chart.appendChild(svgPath(pathD, { fill:'none', stroke:'#22d3ee', 'stroke-width':2.2 }));
}


/* ---------- init ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  $('#lbl-w').textContent=`${state.power} W`;
  $('#lbl-eff').textContent=`${Math.round(state.eff*100)}%`;
  $('#lbl-dur').textContent=fmtDur(state.dur);
  $('#lbl-intakecap').textContent='90';
  $('#lbl-intake').textContent=`${state.intake} g/h`;
  $('#pill-cp').textContent=`CP ${state.cp} · W′ ?`;

  wireInputs();
  recompute();
});
</script>
</body>
</html>
